<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
<div class="container" th:fragment="html" xmlns:th="http://www.thymeleaf.org">
  <div class="row">
    <div class="col-sm-8 blog-main">
      <div class="blog-post">
        <template v-if="condition">
          <h2 class="blog-post-title">{{post.title}}</a></h2>
          <p class="blog-post-meta">{{formDate(post.createdDate)}} created by {{post.userName}}</p>
          <div v-html="marked(post.body)"></div>
        </template>
      </div>
    </div>
    <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
      <div class="sidebar-module">
        <a type="button" class="btn btn-default btn-lg" @click="delPost">
          <span class="glyphicon glyphicon-remove"></span>Delete post
        </a>
      </div>
      <div class="sidebar-module">
        <a type="button" class="btn btn-default btn-lg" :href="'newpost?pid='+pid">
          <span class="glyphicon glyphicon-check"></span>Update post
        </a>
      </div>
      <div class="sidebar-module">
        <a type="button" class="btn btn-default btn-lg" @click="downloadPost">
          <span class="glyphicon glyphicon-download-alt"></span>download post mdFile
        </a>
      </div>
    </div>
  </div>
  <script>
    let pid = getUrlParms("pid")
    let detail = new Vue({
      el: "#workingArea",
      data() {
        return {
          pid: pid,
          uri: 'api/posts/',
          post: null,
          condition: false,

          isAuthenticated: false,
          user: {
            name: '',
            password: '',
            repeatpassword: '',
            isAdmin: false
          },
          rememberMe: false
        }
      },
      mounted: function () {

        marked.setOptions({
          highlight: function (code, lang) {

            let result = hljs.highlight(lang, code).value
            hljs.initLineNumbersOnLoad();
            result = hljs.lineNumbersValue(result)
            return result
          }
        })
        this.load()


      },
      methods: {
        load: function () {
          let url = this.uri + pid
          axios.get(url).then(function (response) {
            detail.post = response.data
            detail.$set(detail, 'condition', true)
          });
        },
        formDate: function (value) {
          if (value === null) {
            return ""
          }
          let formatString = 'YYYY-MM-DD HH:mm:ss'
          return moment(value).format(formatString)
        },
        delPost: function () {
          let url = this.uri + pid
          axios.delete(url).then(function (response) {
            // redirect to homePage
            window.location.href = "/"
          })
        },
        downloadPost: function () {
          let url = this.uri + `download?pid=${pid}`
          const queryArgs = {
            url,
            method: "get",
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json; charset=utf-8',
              withCredentials: true
            },
          }
          axios.request(queryArgs).then(
            response => {
              // 提取文件名 得小写 content-disposition
              const filename = response.headers['content-disposition'].match(
                /filename=(.*)/
              )[1]
              if (typeof filename === "undefined") {
                alert(response.data)
                return
              }
              // 将二进制流转为blob
              const blob = new Blob([response.data], {type: 'application/octet-stream'});
              if (typeof window.navigator.msSaveBlob !== 'undefined') {
                // 兼容IE，window.navigator.msSaveBlob：以本地方式保存文件
                window.navigator.msSaveBlob(blob, decodeURI(filename))
              } else {
                // magic part
                // 创建新的URL并指向File对象或者Blob对象的地址
                const blobURL = window.URL.createObjectURL(blob)
                // 创建a标签，用于跳转至下载链接
                const tempLink = document.createElement('a')
                tempLink.style.display = 'none'
                tempLink.href = blobURL
                tempLink.setAttribute('download', decodeURI(filename))
                // 兼容：某些浏览器不支持HTML5的download属性
                if (typeof tempLink.download === 'undefined') {
                  tempLink.setAttribute('target', '_blank')
                }
                // 挂载a标签
                document.body.appendChild(tempLink)
                tempLink.click()
                document.body.removeChild(tempLink)
                // 释放blob URL地址
                window.URL.revokeObjectURL(blobURL)
              }
            }
          ).catch(err => console.log(err))
        },

        /////////////////////////
        get_user: function () {
          axios({
            method: 'get',
            url: authUri,
            headers: {
              Authorization: getToken()
            }
          }).then(response => {
            if (response.status === 401) {
              this.isAuthenticated = false
              return
            }
            this.isAuthenticated = true
            this.user.isAdmin = response.data.isAdmin
            this.user.name = response.data.name
          }).catch(error => {
            this.isAuthenticated = false
          })
        },
        login_modal: function () {
          console.log('modal clicked')
          $('#loginModal').modal('show')
        },
        register_modal: function () {
          $('#registerModal').modal('show')
        },
        register: function () {

        },
        login: function () {
          axios.post('/login', {
            username: this.user.name,
            password: this.user.password
          }).then(response => {
            if (this.rememberMe) {
              console.log('rememberMe')
              localStorage.setItem("__AUTH__", response.headers.authorization)
            } else {
              sessionStorage.setItem("__AUTH__", response.headers.authorization)
            }
            this.isAuthenticated = true;
            this.user.password = ""
            $('#loginModal').modal('hide')
            this.user.isAdmin = response.data.isAdmin
          }).then(this.getuser)
            .catch(error => {
              this.isAuthenticated = false
              $("span.loginErrorMessage").html("Login failed.")
              $("div.loginErrorMessageDiv").css("visibility", "visible")
            })
        },
        logout: function () {
          console.log("logout")
          axios.get("/logout").then(response => {
              this.isAuthenticated = false
              localStorage.removeItem("__AUTH__")
              sessionStorage.removeItem("__AUTH__")
              this.user.isAdmin = false
              this.user.name = ""
            }
          )
        }

      }
    })
  </script>
</div>